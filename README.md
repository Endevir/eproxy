# EProxy - Enchanced proxy-server

Прокси-сервер на базе nginx с расширенной функциональностью мониторинга и защиты от L7-ddos атак.
За основу взят образ openresty-alpine.

Основные фичи касаются анализа входящего трафика и точек потенциальных ddos-атак на уровне L7, а также раннее обнаружение и блокировка подозрительных клиентов на уровне прокси-сервера.

# Rate-limiting 

# Экспортируемые метрики Prometheus 
Метрики экспортируются на порту 9145 по адресу /metrics

Основные метрики (полезны для алертинга):

| Название | Тип | Лейблы | Описание
| -------- | --- | ------ | -----
| eproxy_http_req_total | counter | host, status | Число запросов с группировкой по хостам и по кодам статусов ответа (200, 403, 502, etc.)
| eproxy_http_connections | gauge | state | Число соединений с сервером
| eproxy_http_req_duration_ms | histogram | host | Распределение запросов по времени длительности запроса (бакеты по 100, 200, 500, 1000, 2000, 3000, 5000, 8000, 10000, 30000, 60000 миллисекунд)
| eproxy_http_proxy_response_time_ms | histogram | upstream | Распределение времени ответа бэкенда по времени длительности запроса (бакеты по 100, 200, 500, 1000, 2000, 3000, 5000, 8000, 10000, 30000, 60000 миллисекунд)
| eproxy_bans_total | counter | host, rule | Число блокировок клиентов
| eproxy_errors_total | counter | | Число внутренних ошибок eproxy

Вспомогательные метрики (полезны для анализа источников аномалий):

| Название | Тип | Лейблы | Описание
| -------- | --- | ------ | -----
| eproxy_http_req_total_by_country | counter | host, status, country | Число запросов с группировкой по стране клиента и кодам ответа
| eproxy_http_req_total_by_asn | counter | host, status, ASN | Число запросов с группировкой по номеру AS клиента и кодам ответа
| eproxy_http_req_total_by_path | counter | host, path | Число запросов с группировкой по путям запроса. Эспортируются данные для только 10 наиболее часто запрашиваемых url'ов для каждого хоста (список таких url'ов обновляется каждые 10 минут) для избежания высокой кардинальности.
| eproxy_http_backend_latency_by_path | gauge | upstream, path | Среднее время бэкенда за последние 10 запросов с группировкой по путям запроса. Эспортируются данные для только 10 наиболее "медленных" url'ов (список таких url'ов обновляется каждые 10 минут) для каждого хоста для избежания высокой кардинальности.

# Производительность и бенчмарки
